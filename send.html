<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Send Package | DM Xpress</title>
</head>
<body style="font-family:sans-serif;text-align:center;padding:2em;">
  <h2>üì§ Send a Package</h2>
  <form id="packageForm">
    <input type="text" placeholder="Package Description" id="desc" required><br><br>
    <input type="number" placeholder="Weight (lbs)" id="weight" required><br><br>
    <input type="text" placeholder="Destination Country" id="dest" required><br><br><input type="tel" placeholder="Phone Number (e.g. +1234567890)" id="phone" required><br><br>
    <button type="button" onclick="calculateCost()">Calculate Cost</button>
  </form>

  <div id="costDetails" style="margin-top:2em; display:none;">
    <h3>üí∞ Cost Breakdown</h3>
    <p id="baseCost"></p>
    <p id="tax"></p>
    <p id="total"></p>
    
    <div id="paymentOptions">
      <h3>üí≥ Choose Payment Method</h3>
      <button onclick="payWithStripe()">Pay with Stripe</button>
      <div id="paypal-button-container" style="margin-top: 1em;"></div>
    </div>
    <div id="paidNotice" style="display:none; color:green; font-weight:bold;">‚úÖ Payment complete! You may now submit your package.</div>

<button onclick="makePayment()" id="submitPackageBtn" disabled>Submit Package</button>
  </div>

  <div id="result" style="margin-top:2em; display:none;">
    <h3>‚úÖ Payment Received!</h3>
    <p><strong>Your Tracking Code:</strong> <span id="trackingCode">DMX8708320180</span></p>
    <div id="printArea">
      <img src="tracking_qr.png" alt="QR Code" width="200" height="200" />
      
    <p><strong>Your Pickup Code:</strong> <span id="pickupCodeDisplay"></span></p>

<p style="font-weight:bold;">Tracking Code: DMX8708320180</p>
    </div>
    <br>
    <button onclick="window.print()">üñ®Ô∏è Print QR & Tracking Code</button>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js">
    // Placeholder: Stripe Payment Function
    function payWithStripe() {
      alert("Redirecting to Stripe payment (simulated)...");
      document.getElementById("submitPackageBtn").disabled = false;
      document.getElementById("paidNotice").style.display = "block";
    }

    // Load PayPal Script
    const script = document.createElement("script");
    script.src = "https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID";
    script.onload = () => {
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: finalTotal.toFixed(2)
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            alert("PayPal payment completed by " + details.payer.name.given_name);
            document.getElementById("submitPackageBtn").disabled = false;
            document.getElementById("paidNotice").style.display = "block";
          });
        }
      }).render("#paypal-button-container");
    };
    document.head.appendChild(script);

</script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js">
    // Placeholder: Stripe Payment Function
    function payWithStripe() {
      alert("Redirecting to Stripe payment (simulated)...");
      document.getElementById("submitPackageBtn").disabled = false;
      document.getElementById("paidNotice").style.display = "block";
    }

    // Load PayPal Script
    const script = document.createElement("script");
    script.src = "https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID";
    script.onload = () => {
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: finalTotal.toFixed(2)
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            alert("PayPal payment completed by " + details.payer.name.given_name);
            document.getElementById("submitPackageBtn").disabled = false;
            document.getElementById("paidNotice").style.display = "block";
          });
        }
      }).render("#paypal-button-container");
    };
    document.head.appendChild(script);

</script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDi-eKOhhM0iBztwH-lk6xB8G_wCJIANxI",
      authDomain: "dm-xpress-1f835.firebaseapp.com",
      projectId: "dm-xpress-1f835",
      storageBucket: "dm-xpress-1f835.firebasestorage.app",
      messagingSenderId: "27426777557",
      appId: "1:27426777557:web:9b89da634b89ee6e55755c",
      measurementId: "G-VPBTR5RZ32"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let finalTotal = 0;

    function calculateCost() {
      const weight = parseFloat(document.getElementById("weight").value);
      if (isNaN(weight) || weight <= 0) {
        alert("Please enter a valid weight.");
        return;
      }

      const baseRate = 5.0;
      const fee = 3.0;
      const taxRate = 0.08;

      const subtotal = weight * baseRate + fee;
      const tax = subtotal * taxRate;
      finalTotal = subtotal + tax;

      document.getElementById("baseCost").innerText = "üì¶ Base Cost + Fee: $" + subtotal.toFixed(2);
      document.getElementById("tax").innerText = "üßæ Tax (8%): $" + tax.toFixed(2);
      document.getElementById("total").innerText = "üí≥ Total Amount Due: $" + finalTotal.toFixed(2);

      document.getElementById("costDetails").style.display = "block";
    }

    function makePayment() {
      const desc = document.getElementById("desc").value;
      const weight = parseFloat(document.getElementById("weight").value);
      const dest = document.getElementById("dest").value;
      const phone = document.getElementById("phone").value;
      const trackCode = document.getElementById("trackingCode").textContent;
      const createdAt = new Date();
      const pickupCode = Math.random().toString(36).substring(2, 8).toUpperCase(); // 6-char code

      const eta = new Date(createdAt.getTime() + 14 * 24 * 60 * 60 * 1000); // +14 days

      db.collection("packages").add({
        description: desc,
        weight: weight,
        destination: dest,
        total: finalTotal,
        trackingCode: trackCode,
        createdAt: firebase.firestore.Timestamp.fromDate(createdAt),
        eta: firebase.firestore.Timestamp.fromDate(eta),
        phone: phone,
        pickupCode: pickupCode,
        deliveryCode: pickupCode,
        statusUpdates: [
          {
            step: "Package Received",
            timestamp: firebase.firestore.Timestamp.fromDate(createdAt)
          }
        ]
      }).then(() => {
        alert("Package saved successfully!");
        const message = `Hello from DM Xpress! üì¶

Thank you for submitting your package. Your pickup code is:

üîë CODE: ${pickupCode}

Use this code to collect your package.

Questions? Chat with us anytime!`;

        // Send WhatsApp message via Ultramsg
        const instanceId = "YOUR_INSTANCE_ID";
        const token = "YOUR_TOKEN";

        fetch(`https://api.ultramsg.com/${instanceId}/messages/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            token: token,
            to: phone,
            body: message
          })
        })
        .then(response => response.json())
        .then(data => console.log("WhatsApp sent:", data))
        .catch(error => console.error("WhatsApp error:", error));

        
        document.getElementById("pickupCodeDisplay").innerText = pickupCode;
        const message = `Hello from DM Xpress! üì¶

Thank you for submitting your package. Your pickup code is:

üîë CODE: ${pickupCode}

Use this code to collect your package.

Questions? Chat with us anytime!`;

        const instanceId = "YOUR_INSTANCE_ID";
        const token = "YOUR_TOKEN";

        fetch(`https://api.ultramsg.com/${instanceId}/messages/chat`, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: new URLSearchParams({
            token: token,
            to: phone,
            body: message
          })
        })
        .then(response => response.json())
        .then(data => console.log("WhatsApp sent:", data))
        .catch(error => console.error("WhatsApp error:", error));


        document.getElementById("result").style.display = "block";
        document.getElementById("costDetails").style.display = "none";
      }).catch((error) => {
        alert("Error saving to Firebase: " + error.message);
      });
    }
  
    // Placeholder: Stripe Payment Function
    function payWithStripe() {
      alert("Redirecting to Stripe payment (simulated)...");
      document.getElementById("submitPackageBtn").disabled = false;
      document.getElementById("paidNotice").style.display = "block";
    }

    // Load PayPal Script
    const script = document.createElement("script");
    script.src = "https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID";
    script.onload = () => {
      paypal.Buttons({
        createOrder: function(data, actions) {
          return actions.order.create({
            purchase_units: [{
              amount: {
                value: finalTotal.toFixed(2)
              }
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(function(details) {
            alert("PayPal payment completed by " + details.payer.name.given_name);
            document.getElementById("submitPackageBtn").disabled = false;
            document.getElementById("paidNotice").style.display = "block";
          });
        }
      }).render("#paypal-button-container");
    };
    document.head.appendChild(script);

</script>
</body>
</html>
